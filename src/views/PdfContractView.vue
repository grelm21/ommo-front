<template>
  <div class="w-full overflow-auto">
    <v-pdf
      ref="pdf"
      :options="pdfOptions"
      filename="–∫–æ–Ω—Ç—Ä–∞–∫—Ç_–ª—é–±–≤–∏_–æ–º–º–æ.pdf"
      class="w-[210mm] h-[296mm] relative bg-white mx-auto"
    >
      <div class="contract-bg flex flex-col py-2">
        <p class="playfair-extrabold text-[38px] text-center">–ö–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –ª—é–±–≤–∏</p>
        <p class="flex w-1/2 mx-auto playfair-normal text-[20px] text-center mt-2">
          (–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä –æ –ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–æ–π –∑–∞—â–∏—Ç–µ –æ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤)
        </p>
        <p class="flex w-fit mx-auto playfair-bold mt-2 text-[20px]">–ü–†–ï–ê–ú–ë–£–õ–ê:</p>
        <p class="flex w-full px-[40px] playfair-normal text-[20px] text-center mt-[1px] text-wrap">
          –°—Ç–æ—Ä–æ–Ω—ã,—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É—è—Å—å –ø–∞—Ä–∞–¥–æ–∫—Å–∞–ª—å–Ω—ã–º –∂–µ–ª–∞–Ω–∏–µ–º –æ–±–µ–∑–æ–ø–∞—Å–∏—Ç—å —Å–µ–±—è –æ—Ç —Ö–∞–æ—Å–∞ —á—É–≤—Å—Ç–≤, –∑–∞–∫–ª—é—á–∏–ª–∏
          –Ω–∞—Å—Ç–æ—è—â–∏–π –¥–æ–≥–æ–≤–æ—Ä –æ –Ω–∏–∂–µ—Å–ª–µ–¥—É—é—â–µ–º. –ù–∞—Å—Ç–æ—è—â–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è,—á—Ç–æ –ª—é–±–æ–≤—å, —Ö–æ—Ç—å –∏ —è–≤–ª—è–µ—Ç—Å—è
          —Ñ–æ—Ä–º–æ–π –≤—ã—Å—à–µ–≥–æ –±–µ–∑—É–º–∏—è, –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–≤–µ—Ä–∂–µ–Ω–∞ —Ä–∞–∑—É–º–Ω–æ–º—É —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—é.
        </p>
        <p class="flex w-fit mx-auto playfair-bold mt-2 text-[20px]">–í–ó–ê–ò–ú–ù–´–ï –û–ë–Ø–ó–ê–¢–ï–õ–¨–°–¢–í–ê</p>
        <p class="flex w-full px-[40px] playfair-normal text-[20px] text-center mt-[1px] text-wrap">
          –í–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ª–µ–π –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–∏–Ω–∏–º–∞—é—Ç –Ω–∞ —Å–µ–±—è —Å–ª–µ–¥—É—é—â–∏–µ –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω—ã–µ
          –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞:
        </p>

        <!-- #–¥–∞–Ω–Ω—ã–µ -->
        <Transition>
          <div
            class="flex flex-grow flex-col items-center justify-center"
            v-show="!contractStore.isLoading"
          >
            <div class="flex w-fit mx-auto playfair-bold text-[22px]">
              {{ nameOne.toUpperCase() }}
            </div>
            <p
              class="flex w-fit px-[40px] playfair-italic text-[20px] text-center mt-[1px] text-wrap"
            >
              –û–±—è–∑—É—é—Å—å {{ promiseOne || '' }}
            </p>

            <div class="flex w-fit mx-auto playfair-bold text-[22px] mt-[30px]">
              {{ nameTwo.toUpperCase() }}
            </div>
            <p
              class="flex w-fit px-[40px] playfair-italic text-[20px] text-center mt-[1px] text-wrap"
            >
              –û–±—è–∑—É—é—Å—å {{ promiseTwo || '' }}
            </p>
          </div>
        </Transition>
        <Transition>
          <div
            ref="placeholder"
            class="flex flex-grow flex-col items-center justify-center"
            v-if="contractStore.isLoading"
          >
            <div role="status" class="space-y-3 animate-pulse w-fit">
              <div class="flex items-center w-full justify-center">
                <div class="h-[20px] bg-[#9D9D9D] rounded-full w-1/2"></div>
              </div>
              <div class="flex items-center justify-center">
                <div class="h-[20px] bg-[#9D9D9D] rounded-full w-full"></div>
                <div class="h-[20px] ms-2 bg-[#9D9D9D] rounded-full w-full"></div>
                <div class="h-[20px] ms-2 bg-[#9D9D9D] rounded-full w-24"></div>
              </div>
              <div class="flex items-center justify-center">
                <div class="h-[20px] bg-[#9D9D9D] rounded-full w-full"></div>
                <div class="h-[20px] ms-2 bg-[#9D9D9D] rounded-full w-80"></div>
                <div class="h-[20px] ms-2 bg-[#9D9D9D] rounded-full w-full"></div>
              </div>
              <span class="sr-only">Loading...</span>
            </div>

            <div role="status" class="space-y-3 animate-pulse w-fit mt-[30px]">
              <div class="flex items-center w-full justify-center">
                <div class="h-[20px] bg-[#9D9D9D] rounded-full w-1/2"></div>
              </div>
              <div class="flex items-center justify-center">
                <div class="h-[20px] bg-[#9D9D9D] rounded-full w-full"></div>
                <div class="h-[20px] ms-2 bg-[#9D9D9D] rounded-full w-full"></div>
                <div class="h-[20px] ms-2 bg-[#9D9D9D] rounded-full w-24"></div>
              </div>
              <div class="flex items-center justify-center">
                <div class="h-[20px] bg-[#9D9D9D] rounded-full w-full"></div>
                <div class="h-[20px] ms-2 bg-[#9D9D9D] rounded-full w-80"></div>
                <div class="h-[20px] ms-2 bg-[#9D9D9D] rounded-full w-full"></div>
              </div>
              <span class="sr-only">Loading...</span>
            </div>
          </div>
        </Transition>

        <p class="flex w-fit mx-auto playfair-bold mt-2 text-[20px]">–í–°–¢–£–ü–õ–ï–ù–ò–ï –í –°–ò–õ–£</p>
        <p class="flex w-full px-[40px] playfair-normal text-[20px] text-center mt-[1px] text-wrap">
          –ù–∞—Å—Ç–æ—è—â–∏–π –¥–æ–≥–æ–≤–æ—Ä –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏–ª—É 28 –Ω–æ—è–±—Ä—è, –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–æ—Å–ª—É—à–∞—é—Ç –ø–µ—Å–Ω—é
          "–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ª—é–±–≤–∏", –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∞–≥–µ–Ω—Ç–æ–º. –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–∂–∞—Ç—å
          –∫–Ω–æ–ø–∫—É ¬´–ø—Ä–µ—Å–µ–π–≤¬ª.
        </p>
        <p class="flex w-full justify-center playfair-normal text-[20px] mt-2">
          –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —Å–æ—Å—Ç–∞–≤–∏–ª–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –ª—é–±–≤–∏.
        </p>
        <p class="flex w-full justify-start playfair-normal text-[16px] mt-2 ms-[40px]">
          –ü–æ–¥–ø–∏—Å–∏ —Å—Ç–æ—Ä–æ–Ω:
        </p>
        <div class="grid grid-cols-2 gap-x-[40px] mt-2 playfair-normal text-[20px] mx-[40px]">
          <div>–°—Ç–æ—Ä–æ–Ω–∞ –ê: _ _ _ _ _ _ _ _ _ _ _ _ _</div>
          <div>–°—Ç–æ—Ä–æ–Ω–∞ –ë: _ _ _ _ _ _ _ _ _ _ _ _ _</div>
          <div class="ms-[110px] text-[16px]">(–í–∞—à–µ –∏–º—è)</div>
          <div class="flex text-wrap text-[16px]">
            (–ò–º—è –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–∫–∏: —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–∞. R2D2 –∏ –¥—Ä—É–≥–∏—Ö —Å—É—â–µ—Å—Ç–≤ –æ–±–ª–∞–¥–∞—é—â–∏—Ö –¥—É—à–æ–π)
          </div>
          <div>–ü–æ–¥–ø–∏—Å—å –∏ –¥–∞—Ç–∞: _ _ _ _ _ _ _ _ _ _</div>
          <div>–ü–æ–¥–ø–∏—Å—å –∏ –¥–∞—Ç–∞: _ _ _ _ _ _ _ _ _ _</div>
        </div>
        <p class="flex w-full justify-center playfair-normal text-[20px] mt-2">
          –ê–≥–µ–Ω—Ç: –ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞ ¬´–û–ú–ú–û¬ª
        </p>
        <p class="flex w-full justify-center playfair-normal text-[20px] mt-2">
          –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: –î–æ –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è / –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞—Å–ø–∞–¥–∞ –í—Å–µ–ª–µ–Ω–Ω–æ–π.
        </p>
        <p class="flex w-full justify-start playfair-normal text-[16px] mt-5 ms-[40px]">
          –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –ø–æ–ª–∏—Å–æ–≤ –ª—é–±–≤–∏ –û–ú–ú–û: @OMMO_SPB
        </p>
        <p class="flex w-full justify-start playfair-normal text-[16px] mt-1 ms-[40px] mb-[20px]">
          –•–µ—à—Ç–µ–≥ –¥–ª—è –ø—Ä–µ–¥—ä—è–≤–ª–µ–Ω–∏—è –ø—Ä–µ—Ç–µ–Ω–∑–∏–π: #–°—Ç—Ä–∞—Ö–æ–≤–∫–∞–õ—é–±–≤–∏–û–ú–ú–û
        </p>
      </div>
    </v-pdf>
  </div>

<div class="flex items-center justify-center mt-8">
  <button
    class="flex gap-[8px] items-center justify-center hover-scale"
    type="button"
    @click="manualDownload"
  >
  <span class="flex text-3xl text-white handjet-normal">
   –°–∫–∞—á–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç
  </span>
    <DownloadIcon class="flex items-center justify-end h-[32px] w-[32px]" />
  </button>
</div>

  <div class="flex gap-[8px] items-center justify-center mt-8">
    <div class="text-3xl text-white handjet-normal">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç:</div>
    <button
      class="flex items-center justify-end h-[32px] w-[32px] hover-scale"
      type="button"
      @click="openPreSave"
    >
      <PreSaveIcon />
    </button>
  </div>
  <div class="flex gap-[8px] items-center justify-center">
    <div class="subscribe handjet-normal">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—Å:</div>
    <button
      class="flex items-center justify-end h-[40px] w-[40px] hover-scale"
      type="button"
      @click="openYouTube"
    >
      <YouTubeIcon />
    </button>
    <button
      class="flex items-center justify-end h-[40px] w-[40px] hover-scale"
      type="button"
      @click="openVk"
    >
      <VkIcon />
    </button>
    <button
      class="flex items-center justify-end h-[40px] w-[40px] hover-scale"
      type="button"
      @click="openTelegram"
    >
      <TelegramIcon />
    </button>
  </div>

  <div class="flex gap-2 items-center justify-center mt-3">
    <button
      class="flex items-center justify-end xl:text-[22px] text-base h-[40px] text-[#7B3994] hover-scale underline handjet-normal"
      type="button"
      @click="resetContract"
    >
      <AgainIcon />
      –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
    </button>
  </div>
</template>

<script setup>
import { ref, defineProps, onMounted, watch, nextTick } from 'vue'
import { useContractStore } from '@/stores/contractStore'
import VkIcon from '@/components/icons/VkIcon.vue'
import YouTubeIcon from '@/components/icons/YouTubeIcon.vue'
import PreSaveIcon from '@/components/icons/PreSaveIcon.vue'
import TelegramIcon from '@/components/icons/TelegramIcon.vue'
import AgainIcon from '@/components/icons/AgainIcon.vue'
import { useRouter } from 'vue-router'
import DownloadIcon from '@/components/icons/DownloadIcon.vue'

const contractStore = useContractStore()

const pdf = ref(true)
const pdfOptions = {
  margin: 0,
  html2canvas: { scale: 4 },
  jsPDF: { unit: 'mm', format: 'a4', orientation: 'p' },
}

// –æ–ø—Ä–µ–¥–µ–ª—è–µ–º iOS
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent)

const props = defineProps({
  id: String,
})

const promiseOne = ref(null)
const promiseTwo = ref(null)

const nameOne = ref('')
const nameTwo = ref('')

const placeholder = ref(true)

const openYouTube = () => {
  window.open('https://youtube.com/@ommo_ommo_ommo?si=WaPUf-Z6CVzSkuv', '_blank')
}
const openVk = () => {
  window.open('https://vk.com/club232985627', '_blank')
}
const openTelegram = () => {
  window.open('https://t.me/OMMO_spb', '_blank')
}

// –≠—Ç–æ —Ç–µ–ø–µ—Ä—å –ø—Ä–µ—Å–µ–π–≤
const openPreSave = () => {
  window.open('https://band.link/MVTNL', '_blank')
}

onMounted(async () => {
  await contractStore.fetchContract(props.id)
})

const removePlaceholder = () => {
  if (placeholder.value) {
    placeholder.value = false
  }
}

const router = useRouter()

const resetContract = () => {
  router.push('/')
}

// —Ä—É—á–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ (–∫–Ω–æ–ø–∫–∞)
const manualDownload = async () => {
  alert('üöÄ –ù–∞—á–∞–ª–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è')

  try {
    // –ú–µ—Ç–æ–¥ 1: –ß–µ—Ä–µ–∑ blobPdf —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º URL
    if (typeof pdf.value.blobPdf === 'function') {
      const pdfBlob = await pdf.value.blobPdf()
      const timestamp = new Date().getTime()
      const pdfUrl = URL.createObjectURL(pdfBlob)

      // –°–æ–∑–¥–∞–µ–º iframe –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
      const iframe = document.createElement('iframe')
      iframe.style.display = 'none'
      iframe.src = pdfUrl
      document.body.appendChild(iframe)

      // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É —Å –£–ù–ò–ö–ê–õ–¨–ù–´–ú –ò–ú–ï–ù–ï–ú
      const link = document.createElement('a')
      link.href = pdfUrl
      link.download = `–∫–æ–Ω—Ç—Ä–∞–∫—Ç_–ª—é–±–≤–∏_–æ–º–º–æ_${timestamp}.pdf` // ‚Üê –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
      link.target = '_blank'
      link.style.display = 'none'

      document.body.appendChild(link)

      // –ü—Ä–æ–±—É–µ–º –æ–±–∞ –º–µ—Ç–æ–¥–∞
      link.click()

      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –∏ –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
      setTimeout(() => {
        // –í—Ç–æ—Ä–æ–π –∫–ª–∏–∫
        link.click()

        // –¢—Ä–µ—Ç–∏–π –ø–æ–¥—Ö–æ–¥ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
        window.open(pdfUrl, '_blank')

        alert('üìÑ –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å–∫–∞—á–∞–ª—Å—è:\n1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É –ó–∞–≥—Ä—É–∑–∫–∏\n2. –ò–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑ –æ—Ç–∫—Ä—ã–≤—à–µ–π—Å—è –≤–∫–ª–∞–¥–∫–∏')
      }, 1000)

      // –û—á–∏—Å—Ç–∫–∞
      setTimeout(() => {
        document.body.removeChild(link)
        document.body.removeChild(iframe)
        URL.revokeObjectURL(pdfUrl)
      }, 10000)

    } else {
      // –ú–µ—Ç–æ–¥ 2: –ü—Ä—è–º–æ–π download —Å –£–ù–ò–ö–ê–õ–¨–ù–´–ú –ò–ú–ï–ù–ï–ú
      const timestamp = new Date().getTime()
      pdf.value.filename = `–∫–æ–Ω—Ç—Ä–∞–∫—Ç_–ª—é–±–≤–∏_–æ–º–º–æ_${timestamp}.pdf` // ‚Üê –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
      await pdf.value.download()
      alert('‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!')
    }

  } catch (error) {
    alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message)

    // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å –£–ù–ò–ö–ê–õ–¨–ù–´–ú –ò–ú–ï–ù–ï–ú
    const timestamp = new Date().getTime()
    pdf.value.filename = `–∫–æ–Ω—Ç—Ä–∞–∫—Ç_–ª—é–±–≤–∏_–æ–º–º–æ_${timestamp}.pdf` // ‚Üê –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
    pdf.value.openInNewTab()
    alert('üìÑ PDF –æ—Ç–∫—Ä—ã—Ç –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞.')
  }
}

// –∞–≤—Ç–æ-—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ù–ï iOS
watch(
  () => contractStore.contract,
  async (newContract) => {
    if (newContract) {
      nameOne.value = newContract.partners[0]?.name
      nameTwo.value = newContract.partners[1]?.name
      promiseOne.value = newContract.partners[0]?.promise?.description
      promiseTwo.value = newContract.partners[1]?.promise?.description

      await nextTick()

      if (!isIOS) {
        setTimeout(() => pdf.value.download(), 1000)
      }
    }
  },
)
</script>


<style scoped>
.contract-bg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  background-image:
    linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.9)),
    url('@/assets/logo-pdf.svg');
  background-repeat: repeat, repeat;
  background-size: auto auto;
  background-blend-mode: lighten;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
th,
td {
  border: 1px solid #ccc;
  padding: 6px 10px;
  text-align: left;
}
th {
  background: #f0f0f0;
}


.subscribe {
  font-size: 32px;
  color: #ffffff;
  text-shadow:
    -2px -2px 0 #5449a8,
    2px -2px 0 #5449a8,
    -2px 2px 0 #5449a8,
    2px 2px 0 #5449a8;
}
</style>
